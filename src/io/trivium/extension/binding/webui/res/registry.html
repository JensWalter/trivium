<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>trivium registry</title>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/rivets.bundled.min.js"></script>
    <script type="text/jsx">
      /** @jsx React.DOM */
      var all = {};
      var ExtensionList = React.createClass({
          getInitialState: function () {
            var that = this;
            $.ajax({
                type: "POST",
                url: '/ui/RegistryRequestHandler',
                data: JSON.stringify({"command":"list"}),
                success: function(data){
        all=data;
                        that.setState({task: data.task});
                        that.setState({binding: data.binding});
                        that.setState({type: data.type});
                    }
                });
            return {};
          },
          render: function() {
            return (<div>
                    {this.state.task ? <Task id={this.state.task} /> : ''}
                    {this.state.binding ? <Binding id={this.state.binding} /> :''}
                    {this.state.type ? <Type id={this.state.type} /> : ''}
                    </div>);
          }
      });
      var Type = React.createClass({
      	  getInitialState: function(){
      	  	return {};
      	  },
          render: function() {
          var elements = this.props.id.map(function(e){
                return (<li key={e}>{all[e]}</li>);
            });
            return (<div>Type: <ul>{elements}</ul></div>);
          }
      });
      var BindingEntry = React.createClass({
        getInitialState: function(){
      	    var that = this;
            $.ajax({
                type: "POST",
                url: '/ui/RegistryRequestHandler',
                data: JSON.stringify({id:this.props.id,command:"status"}),
                success: function(data){
                        that.setState({state:data.state});
                    }
                });
      	  	return {logmessage:''};
      	  },
      	  start: function(){
      	  var that = this;
              $.ajax({
                type: "POST",
                url: '/ui/RegistryRequestHandler',
                data: JSON.stringify({id:this.props.id,command:"start"}),
                success: function(data){
                        console.log(data.trim());
                        if(data.length>0)
                             that.setState({state:"running",
                                    logmessage:data});
                    }
                });

      	  },
      	  stop: function(){
      	  var that = this;
      	    $.ajax({
                type: "POST",
                url: '/ui/RegistryRequestHandler',
                data: JSON.stringify({id:this.props.id,command:"stop"}),
                success: function(data){
                        console.log(data.trim());
                        if(data.trim()=="true")
                             that.setState({state:"stopped"});
                    }
                });
      	  },
      	  render: function() {
            return (<li>{all[this.props.id]} =&gt;
                {this.state.state=="stopped"?<button onClick={this.start}>start</button>:''}
                {this.state.state=="running"?<button onClick={this.stop}>stop</button>:''}
                {this.state.logmessage.length>0?<p style={{border:'1px solid grey',backgroundColor:'lightgrey',
                    marginLeft:'10px',marginRight:'10px'}}>{this.state.logmessage}</p>:''}
                    </li>);
          }
      });
      var Binding = React.createClass({
      	  getInitialState: function(){
      	    var that = this;
            $.ajax({
                type: "POST",
                url: '/ui/RegistryRequestHandler',
                data: JSON.stringify({id:this.props.id,command:"status"}),
                success: function(data){
                        that.setState({state:data.state});
                    }
                });
      	  	return {};
      	  },
          render: function() {
            var entries = this.props.id.map(function(e){ return <BindingEntry key={e} id={e} />; });
            return (<div>Binding: <ul>{entries}</ul></div>);
          }
      });
      var Task = React.createClass({
      	  getInitialState: function(){
      	  	return {};
      	  },
          render: function() {
            var elements = this.props.id.map(function(e){
                return (<li key={e}>{all[e]}</li>);
            });
            return (<div>Task: <ul>{elements}</ul></div>);
          }
      });

  //    React.render(<ExtensionList />, document.getElementById("container"));
    </script>
</head>
<body>
    <template id="typeListElement">
        <style>
        </style>
        <tr>
            <td class="typeName"></td>
            <td class="typeAction"><a href="#">show source</a></td>
        </tr>
    </template>
    <template id="taskListElement">
        <style>
        </style>
        <tr>
            <td class="taskName"></td>
            <td class="taskAction"><a href="#">show source</a></td>
        </tr>
    </template>
    <template id="bindingListElement">
        <style>
        </style>
        <tr>
            <td class="bindingName"></td>
            <td class="bindingAction">
                <a href="#">start</a>
                <a href="#">stop</a>
            </td>
        </tr>
    </template>
	<h1>trivium registry</h1>
	<div id="container">
        <div>Type:
            <table id="typeList">
            </table>
        </div>
        <div>Task:
            <table id="taskList">
            </table>
        </div>
        <div>Binding:
            <table id="bindingList">
            </table>
        </div>
    </div>
</body>
<script>
        $.ajax({
                type: "POST",
                url: '/ui/RegistryRequestHandler',
                data: JSON.stringify({"command":"listTypes"}),
                success: function(data){
                    var t = document.querySelector('#typeListElement');
                    for(var idx in data){
                        var clone = t.content.cloneNode(true);
                        clone.querySelector('.typeName').textContent = data[idx]+" ["+idx+"]";
                        clone.querySelector('.typeAction a').href = 'type.html?type='+idx;
                        document.querySelector('#typeList').appendChild(clone);
                    }
                    }
                });
            $.ajax({
                type: "POST",
                url: '/ui/RegistryRequestHandler',
                data: JSON.stringify({"command":"listTasks"}),
                success: function(data){
                    var t = document.querySelector('#taskListElement');
                    for(var idx in data){
                        var clone = t.content.cloneNode(true);
                        clone.querySelector('.taskName').textContent = data[idx];
                        document.querySelector('#taskList').appendChild(clone);
                    }
                    }
                });
            $.ajax({
                type: "POST",
                url: '/ui/RegistryRequestHandler',
                data: JSON.stringify({"command":"listBindings"}),
                success: function(data){
                    var t = document.querySelector('#bindingListElement');
                    for(var idx in data){
                        var clone = t.content.cloneNode(true);
                        clone.querySelector('.bindingName').textContent = data[idx];
                        document.querySelector('#bindingList').appendChild(clone);
                    }
                    }
                });
</script>
</html>